<!DOCTYPE html>
<html>
  <head>
    <title>GIN.IO | Tutorial</title>
      <meta http-equiv="content-type" content="text/html; charset=UTF-8" \>
      <meta name="description"
          content="A fast, low-latency, low-memory footprint, web JSON-API framework with Test Driven Development helpers and patterns"/>

      <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400' rel='stylesheet' type='text/css'>
      <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>

      <link rel="stylesheet" href="./assets/application-1359763b6d352d2ceadd1d7e5ce63c2a.css">
      <script src="./assets/application-dfb7ed62b2c9fe2bb66c4adc6a003717.js"></script>
  </head>

  <body>
    <div id="header">
      <div class="container">
        <div class="title">
          <a href="./">GIN.IO</a>
        </div>

        <div class="top-nav">
          <ul>
            <li><a href="./">Home</a></li>
            <li><a href="./docs/install.html">Docs</a></li>
            <li><a href="./tutorial.html">Tutorial</a></li>
            <li><a href="https://github.com/ostinelli/gin">Source</a></li>
          </ul>
        </div>
      </div>
    </div>


<div class="wrapper">
  <div class="container">

    <div class="main">
      <h1>Tutorial</h1>

<p>This is a simple tutorial showing how to build a Gin application from the grounds up.</p>

<p>This tutorial showcases the use of <a href="http://en.wikipedia.org/wiki/Test-driven_development">Test-Driven Development</a> techniques to build a simple application that allows to see a list of users, and perform basic operations on them.</p>

<blockquote>
<p>For the purpose of this tutorial we have omitted API authentication. We also assume that you have Gin and MySql properly installed. If not, follow the <a href="./docs/install.html">install instructions</a> before proceeding.</p>
</blockquote>

<p>The code of this tutorial can be found in the Github repo <a href="https://github.com/ostinelli/gin-demo">gin-demo</a>.</p>

<h6>Create application</h6>

<p>Let&#39;s create an application called <code>demo</code>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gin new demo
Creating app demo...
  created file demo/spec/models/.gitkeep
  created file demo/app/models/.gitkeep
  created file demo/spec/spec_helper.lua
  created file demo/config/settings.lua
  created file demo/spec/controllers/1/pages_controller_spec.lua
  created file demo/db/schemas/.gitkeep
  created file demo/db/mysql.lua
  created file demo/config/nginx.conf
  created file demo/config/errors.lua
  created file demo/lib/.gitkeep
  created file demo/config/application.lua
  created file demo/app/controllers/1/pages_controller.lua
  created file demo/db/migrations/.gitkeep
  created file demo/.gitignore
  created file demo/config/routes.lua
</code></pre></div>
<p>Let&#39;s now CD in the newly created directory:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>demo
</code></pre></div>
<h6>Run the default tests</h6>

<p>The autogenerated application includes a controller and its tests. Ensure that everything works properly by running <code>busted</code>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted

●
<span class="m">1</span> success / <span class="m">0</span> failures / <span class="m">0</span> pending : 0.052732 seconds.
</code></pre></div>
<h6>Remove the existing controller and controller spec</h6>

<p>We will not need the autogenerated application&#39;s controller and its test file. Go ahead and delete them:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>rm app/controllers/1/pages_controller.lua
<span class="nv">$ </span>rm spec/controllers/1/pages_controller_spec.lua
</code></pre></div>
<h3>Users index</h3>

<p>Let&#39;s start by implementing a Users&#39; <code>index</code> API call.</p>

<h6>Create the Users&#39; controller test file</h6>

<p>Create the file <code>./spec/controllers/1/users_controller_spec.lua</code>, and let&#39;s write the first test:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">require</span> <span class="s1">&#39;</span><span class="s">spec.spec_helper&#39;</span>


<span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">UsersController&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">#index&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
        <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">shows the list of users&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GET&#39;</span><span class="p">,</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users&quot;</span>
            <span class="p">})</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">({},</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>As a start, we just want our Users&#39; controller to return a successful response with an empty JSON body. Let&#39;s run the tests:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controller_spec.lua

●
<span class="m">0</span> successes / <span class="m">1</span> failure / <span class="m">0</span> pending : 0.024976 seconds.

Failure → ./spec/controllers/1/users_controllers_spec.lua @ 6
UsersController / <span class="c">#index / shows the list of users</span>
./spec/controllers/1/users_controllers_spec.lua:12: Expected objects to be the same. Passed in:
<span class="o">(</span>number<span class="o">)</span> 404
Expected:
<span class="o">(</span>number<span class="o">)</span> 200
</code></pre></div>
<p>That is to be expected, as we obviously still do not have created the users&#39; controller nor have we specified the routes to handle the request on <code>/users</code>.</p>

<h6>Add the routes</h6>

<p>Edit the file <code>./config/routes.lua</code>. Let&#39;s create a version <code>1</code> namespace, and the route to <code>/users</code>.</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">routes</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">gin.core.routes&#39;</span>

<span class="c1">-- define version</span>
<span class="kd">local</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">routes</span><span class="p">.</span><span class="n">version</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- define routes</span>
<span class="n">v1</span><span class="p">:</span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">controller</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">users&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">index&quot;</span> <span class="p">})</span>

<span class="k">return</span> <span class="n">routes</span>
</code></pre></div>
<h6>Create Users&#39; controller</h6>

<p>Create the file <code>./app/controllers/1/users_controller.lua</code>, and add the action for the route that we have just defined:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">UsersController</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nf">UsersController</span><span class="p">:</span><span class="n">index</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{}</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">UsersController</span>
</code></pre></div>
<p>Our tests will now pass:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controller_spec.lua

●
<span class="m">1</span> success / <span class="m">0</span> failures / <span class="m">0</span> pending : 0.027029 seconds.
</code></pre></div>
<p>Congratulations! Now let&#39;s modify our controller to return the users in the database.</p>

<h6>Setup Database</h6>

<p>We will be using a MySql database, so let&#39;s edit the <code>./db/mysql.lua</code> file with our settings.</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">SqlDatabase</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">gin.db.sql&#39;</span>
<span class="kd">local</span> <span class="n">Gin</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">gin.core.gin&#39;</span>

<span class="c1">-- First, specify the environment settings for this database, for instance:</span>
<span class="kd">local</span> <span class="n">DbSettings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">development</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">mysql&#39;</span><span class="p">,</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span><span class="p">,</span>
        <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">demo_development&quot;</span><span class="p">,</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">root&quot;</span><span class="p">,</span>
        <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">},</span>

    <span class="n">test</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">mysql&#39;</span><span class="p">,</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span><span class="p">,</span>
        <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">demo_test&quot;</span><span class="p">,</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">root&quot;</span><span class="p">,</span>
        <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">},</span>

    <span class="n">production</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">mysql&#39;</span><span class="p">,</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span><span class="p">,</span>
        <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">demo_production&quot;</span><span class="p">,</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">root&quot;</span><span class="p">,</span>
        <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">,</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">-- Then initialize and return your database:</span>
<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="n">SqlDatabase</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">DbSettings</span><span class="p">[</span><span class="n">Gin</span><span class="p">.</span><span class="n">env</span><span class="p">])</span>

<span class="k">return</span> <span class="n">MySql</span>
</code></pre></div>
<p>We have now defined a connection to our MySql database.</p>

<h6>Create a Users&#39; table</h6>

<p>Let&#39;s go ahead and generate a new migration for the newly created <code>MySql</code> connection:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gin generate migration
Created new migration file
  db/migrations/20131116131423.lua
</code></pre></div>
<p>Edit the file <code>./db/migrations/20131116131423.lua</code> to create the <code>users</code> table in the <code>up()</code> method (called when the migration is run), and destroy it in the <code>down()</code> method (when the migration is rolled back), like this:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">SqlMigration</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- specify the database used in this migration (needed by the Gin migration engine)</span>
<span class="n">SqlMigration</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>

<span class="k">function</span> <span class="nc">SqlMigration</span><span class="p">.</span><span class="nf">up</span><span class="p">()</span>
    <span class="c1">-- Run your migration</span>
    <span class="n">SqlMigration</span><span class="p">.</span><span class="n">db</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s">[[</span>
<span class="s">        CREATE TABLE users (</span>
<span class="s">            id int NOT NULL AUTO_INCREMENT,</span>
<span class="s">            first_name varchar(255) NOT NULL,</span>
<span class="s">            last_name varchar(255),</span>
<span class="s">            PRIMARY KEY (id),</span>
<span class="s">            UNIQUE (first_name)</span>
<span class="s">        );</span>
<span class="s">    ]]</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">SqlMigration</span><span class="p">.</span><span class="nf">down</span><span class="p">()</span>
    <span class="c1">-- Run your rollback</span>
    <span class="n">SqlMigration</span><span class="p">.</span><span class="n">db</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s">[[</span>
<span class="s">        DROP TABLE users;</span>
<span class="s">    ]]</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">SqlMigration</span>
</code></pre></div>
<p>Let&#39;s now apply the migration in the <code>test</code> environment:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ GIN_ENV</span><span class="o">=</span><span class="nb">test </span>gin migrate
Migrating up in <span class="nb">test </span><span class="nv">environment</span>
<span class="o">==</span>&gt; Successfully applied migration: 20131116131423
</code></pre></div>
<blockquote>
<p>The migration engine has created the database <code>demo_test</code> for us.</p>
</blockquote>

<h6>Create Users model</h6>

<p>In order to return users, we first need to create a <code>Users</code> model. Go ahead and create the file <code>./app/models/users.lua</code>, with this content:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="c1">-- gin</span>
<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>
<span class="kd">local</span> <span class="n">SqlOrm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">gin.db.sql.orm&#39;</span>

<span class="c1">-- define</span>
<span class="k">return</span> <span class="n">SqlOrm</span><span class="p">.</span><span class="n">define_model</span><span class="p">(</span><span class="n">MySql</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">users&#39;</span><span class="p">)</span>
</code></pre></div>
<p>This defines a model <code>Users</code> that corresponds to the database table <code>users</code>, for the database connection <code>MySql</code>.</p>

<blockquote>
<p>By convention, models in Gin have plural names.</p>
</blockquote>

<h6>Modify Users&#39; controller test</h6>

<p>Let&#39;s now modify the Users&#39; controller test to return users. Edit the file <code>./spec/controllers/1/users_controller_spec.lua</code> to add some fixture users in our database:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">require</span> <span class="s1">&#39;</span><span class="s">spec.spec_helper&#39;</span>

<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">clean_db</span><span class="p">()</span>
    <span class="n">MySql</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">TRUNCATE TABLE users;&quot;</span><span class="p">)</span>
<span class="k">end</span>


<span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">UsersController&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">#index&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
        <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
            <span class="n">roberto</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">create</span><span class="p">({</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">roberto&#39;</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">gin&#39;</span><span class="p">})</span>
            <span class="n">hedy</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">create</span><span class="p">({</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hedy&#39;</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tonic&#39;</span><span class="p">})</span>
        <span class="k">end</span><span class="p">)</span>

        <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
            <span class="n">roberto</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="n">hedy</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="k">end</span><span class="p">)</span>

        <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">shows the list of users ordered by first name&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GET&#39;</span><span class="p">,</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users&quot;</span>
            <span class="p">})</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">({</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hedy</span><span class="p">,</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">roberto</span>
            <span class="p">},</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>Please note that in Lua, arrays start with index <code>1</code>, hence the expectations above.</p>

<blockquote>
<p>Remember to clean up after your tests, this is what the <code>MySql:execute(&quot;TRUNCATE TABLE users;&quot;)</code> call in <code>clean_db()</code> is for. We are calling <code>clean_db()</code> before and after all tests, to ensure that the database has a clean start even in the case that previous tests were run improperly or aborted for any reason.</p>

<p>Also, don&#39;t forget to reset any global variables, like <code>roberto</code> and <code>hedy</code> in the example here above.</p>
</blockquote>

<p>Let&#39;s run the controller tests:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●
<span class="m">0</span> successes / <span class="m">1</span> failure / <span class="m">0</span> pending : 0.072839 seconds.

Failure → ./spec/controllers/1/users_controllers_spec.lua @ 31
UsersController / <span class="c">#index / shows the list of users ordered by first name</span>
./spec/controllers/1/users_controllers_spec.lua:39: Expected objects to be the same. Passed in:
<span class="o">(</span>table<span class="o">)</span>: <span class="o">{</span> <span class="o">}</span>
Expected:
<span class="o">(</span>table<span class="o">)</span>: <span class="o">{</span>
  <span class="o">[</span>2<span class="o">]</span> <span class="o">=</span> <span class="o">{</span>
    <span class="o">[</span>last_name<span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;gin&#39;</span>
    <span class="o">[</span>first_name<span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;roberto&#39;</span>
    <span class="o">[</span>id<span class="o">]</span> <span class="o">=</span> <span class="m">1</span> <span class="o">}</span>
  <span class="o">[</span>1<span class="o">]</span> <span class="o">=</span> <span class="o">{</span>
    <span class="o">[</span>last_name<span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;tonic&#39;</span>
    <span class="o">[</span>first_name<span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;hedy&#39;</span>
    <span class="o">[</span>id<span class="o">]</span> <span class="o">=</span> <span class="m">2</span> <span class="o">}</span> <span class="o">}</span>
</code></pre></div>
<p>Let&#39;s go ahead and edit the controller:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">UsersController</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nf">UsersController</span><span class="p">:</span><span class="n">index</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>
    <span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">all</span><span class="p">({</span> <span class="n">order</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">first_name&quot;</span> <span class="p">})</span>

    <span class="k">return</span> <span class="mi">200</span><span class="p">,</span> <span class="n">users</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">UsersController</span>
</code></pre></div>
<blockquote>
<p>For optimization reasons, ensure that you require the <code>Users</code> model in the controller action itself, not at module level.</p>
</blockquote>

<p>If we run our tests now:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●
<span class="m">1</span> success / <span class="m">0</span> failures / <span class="m">0</span> pending : 0.073925 seconds.
</code></pre></div>
<p>Great! Now what about smoke testing our application in a browser?</p>

<h6>Prepare the development environment</h6>

<p>Ensure migrations are run in the <code>development</code> environment:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gin migrate
Migrating up in development <span class="nv">environment</span>
<span class="o">==</span>&gt; Successfully applied migration: 20131116131423
</code></pre></div>
<p>Now let&#39;s create some fake users in the <code>development</code> database, from the Gin console:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gin console
Loading development environment <span class="o">(</span>Gin v0.1<span class="o">)</span>
Lua 5.1.5  Copyright <span class="o">(</span>C<span class="o">)</span> 1994-2012 Lua.org, PUC-Rio
&gt; <span class="nv">Users</span> <span class="o">=</span> require <span class="s1">&#39;app.models.users&#39;</span>
&gt; Users.create<span class="o">({</span><span class="nv">first_name</span> <span class="o">=</span> <span class="s1">&#39;roberto&#39;</span>, <span class="nv">last_name</span> <span class="o">=</span> <span class="s1">&#39;gin&#39;</span><span class="o">})</span>
&gt; Users.create<span class="o">({</span><span class="nv">first_name</span> <span class="o">=</span> <span class="s1">&#39;hedy&#39;</span>, <span class="nv">last_name</span> <span class="o">=</span> <span class="s1">&#39;tonic&#39;</span><span class="o">})</span>
&gt; pp<span class="o">(</span>Users.all<span class="o">())</span>
<span class="o">{</span>
  <span class="o">{</span>
    <span class="nv">first_name</span> <span class="o">=</span> <span class="s2">&quot;roberto&quot;</span>,
    <span class="nv">last_name</span> <span class="o">=</span> <span class="s2">&quot;gin&quot;</span>,
    <span class="nv">id</span> <span class="o">=</span> 1
  <span class="o">}</span>,
  <span class="o">{</span>
    <span class="nv">first_name</span> <span class="o">=</span> <span class="s2">&quot;hedy&quot;</span>,
    <span class="nv">last_name</span> <span class="o">=</span> <span class="s2">&quot;tonic&quot;</span>,
    <span class="nv">id</span> <span class="o">=</span> 2
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>As we can see from the <code>pp</code> command (aka &#39;pretty print&#39;) issued in the console, our users have successfully been created in the <code>development</code> database. Quit the console with <code>CTRL-C</code>.</p>

<p>Let&#39;s start a server in the <code>development</code> environment:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gin start
Gin app in development was succesfully started on port 7200.
</code></pre></div>
<p>Open up a browser and point it to the <a href="./docs/api_console.html">API Console</a> at the address <a href="http://localhost:7200/ginconsole">http://localhost:7200/ginconsole</a>.</p>

<p>Input <code>http://localhost:7200/users</code> in the API Console URL bar, and click on the <code>HIT</code> button. You should see the response body from your server:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;tonic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;hedy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;gin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;roberto&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<h3>Users create</h3>

<p>Let&#39;s now implement the Users&#39; <code>create</code> API call.</p>

<blockquote>
<p>For readability concerns, code related to the <code>index</code> action described in the previous section is partially omitted.</p>
</blockquote>

<h6>Add controller&#39;s test</h6>

<p>Edit your controller test to add the tests for the <code>create</code> action.</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">require</span> <span class="s1">&#39;</span><span class="s">spec.spec_helper&#39;</span>

<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">clean_db</span><span class="p">()</span>
    <span class="n">MySql</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">TRUNCATE TABLE users;&quot;</span><span class="p">)</span>
<span class="k">end</span>


<span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">UsersController&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">#create&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
        <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">adds a new user&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">POST&#39;</span><span class="p">,</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span>
                <span class="n">body</span> <span class="o">=</span> <span class="p">{</span> <span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">new-user&#39;</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">gin&#39;</span> <span class="p">}</span>
            <span class="p">})</span>

            <span class="kd">local</span> <span class="n">new_user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">find_by</span><span class="p">({</span> <span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">new-user&#39;</span> <span class="p">})</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are_not</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">new_user</span><span class="p">)</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">(</span><span class="n">new_user</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>Running the tests returns an error:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●●
<span class="m">1</span> success / <span class="m">1</span> failure / <span class="m">0</span> pending : 0.133645 seconds.

Failure → ./spec/controllers/1/users_controllers_spec.lua @ 47
UsersController / <span class="c">#create / adds a new user</span>
./spec/controllers/1/users_controllers_spec.lua:57: Expected objects to be the same. Passed in:
<span class="o">(</span>number<span class="o">)</span> 404
Expected:
<span class="o">(</span>number<span class="o">)</span> 201
</code></pre></div>
<p>The passing test is obviously the one related to the <code>index</code> action.</p>

<p>Create the route for the <code>create</code> action, by editing the <code>./config/routes.lua</code> file:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">routes</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">gin.core.routes&#39;</span>

<span class="c1">-- define version</span>
<span class="kd">local</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">routes</span><span class="p">.</span><span class="n">version</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- define routes</span>
<span class="n">v1</span><span class="p">:</span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">controller</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">users&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">index&quot;</span> <span class="p">})</span>
<span class="n">v1</span><span class="p">:</span><span class="n">POST</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">controller</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">users&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">create&quot;</span> <span class="p">})</span>

<span class="k">return</span> <span class="n">routes</span>
</code></pre></div>
<p>Edit the Users&#39; controller in <code>./app/controllers/1/users_controller.lua</code> to add the create action:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">UsersController</span> <span class="o">=</span> <span class="p">{}</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="k">function</span> <span class="nf">UsersController</span><span class="p">:</span><span class="n">create</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>
    <span class="kd">local</span> <span class="n">new_user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">201</span><span class="p">,</span> <span class="n">new_user</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">UsersController</span>
</code></pre></div>
<p>Let&#39;s run the tests again:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●●
<span class="m">2</span> successes / <span class="m">0</span> failures / <span class="m">0</span> pending : 0.166405 seconds.
</code></pre></div>
<p>We are now able to allow for user creation.</p>

<h6>Accepted params</h6>

<p>We&#39;re currently not filtering out the params that we are allowing external callers to set in our models. In this example, for instance, we do not want an external caller to be able to set the <code>id</code> they want on new users, nor to make our server raise an error due to non-existent params being passed in.</p>

<p>Add the test:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">require</span> <span class="s1">&#39;</span><span class="s">spec.spec_helper&#39;</span>

<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">clean_db</span><span class="p">()</span>
    <span class="n">MySql</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">TRUNCATE TABLE users;&quot;</span><span class="p">)</span>
<span class="k">end</span>


<span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">UsersController&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">#create&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
        <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">adds a new user filtering out unaccepted params&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">request_new_user</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">new-user&#39;</span><span class="p">,</span>
                <span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">gin&#39;</span><span class="p">,</span>
                <span class="n">id</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
                <span class="n">nonexisent_param</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">non-existent&#39;</span>
            <span class="p">}</span>

            <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">POST&#39;</span><span class="p">,</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">request_new_user</span>
            <span class="p">})</span>

            <span class="kd">local</span> <span class="n">new_user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">find_by</span><span class="p">({</span> <span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">new-user&#39;</span> <span class="p">})</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are_not</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">new_user</span><span class="p">)</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">new-user&#39;</span><span class="p">,</span> <span class="n">new_user</span><span class="p">.</span><span class="n">first_name</span><span class="p">)</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">gin&#39;</span><span class="p">,</span> <span class="n">new_user</span><span class="p">.</span><span class="n">last_name</span><span class="p">)</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">not_equals</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">new_user</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">not_equals</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">non-existent&#39;</span><span class="p">,</span> <span class="n">new_user</span><span class="p">.</span><span class="n">nonexisent_param</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●●
<span class="m">1</span> success / <span class="m">1</span> failure / <span class="m">0</span> pending : 0.138575 seconds.

Failure → ./spec/controllers/1/users_controllers_spec.lua @ 47
UsersController / <span class="c">#create / adds a new user filtering out unaccepted params</span>
./spec/controllers/1/users_controllers_spec.lua:62: Expected objects to not be equal. Passed in:
<span class="o">(</span>nil<span class="o">)</span>
Did not expect:
<span class="o">(</span>nil<span class="o">)</span>
</code></pre></div>
<p>We can see that the user did not get created. If we open up the test logs (file <code>logs/test-error.log</code>), we see:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">2013/11/16 14:09:28 [error] 11545#0: *1 lua entry thread aborted: runtime error: /usr/local/share/lua/5.1/gin/core/router.lua:145: /usr/local/share/lua/5.1/gin/db/sql/mysql/adapter.lua:94: bad mysql result: Unknown column &#39;nonexisent_param&#39; in &#39;field list&#39;: 1054 42S22
stack traceback:
coroutine 0:
    [C]: in function &#39;error&#39;
    /usr/local/share/lua/5.1/gin/core/router.lua:145: in function &#39;call_controller&#39;
    /usr/local/share/lua/5.1/gin/core/router.lua:74: in function &#39;handler&#39;
    [string &quot;content_by_lua&quot;]:1: in function &lt;[string &quot;content_by_lua&quot;]:1&gt;, client: 127.0.0.1, server: , request: &quot;POST /users? HTTP/1.1&quot;, host: &quot;127.0.0.1&quot;
</code></pre></div>
<p>This explains why our user did not get created, since there&#39;s an <code>Unknown column &#39;nonexisent_param&#39; in &#39;field list&#39;</code>.</p>

<p>Let&#39;s implement the filter with the controller&#39;s <code>accepted_params</code> method:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">UsersController</span> <span class="o">=</span> <span class="p">{}</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="k">function</span> <span class="nf">UsersController</span><span class="p">:</span><span class="n">create</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>

    <span class="kd">local</span> <span class="n">params</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">accepted_params</span><span class="p">({</span> <span class="s1">&#39;</span><span class="s">first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">last_name&#39;</span> <span class="p">},</span> <span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">new_user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">201</span><span class="p">,</span> <span class="n">new_user</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">UsersController</span>
</code></pre></div>
<p>Our tests are now successful:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●●
<span class="m">2</span> successes / <span class="m">0</span> failures / <span class="m">0</span> pending : 0.138814 seconds.
</code></pre></div>
<h3>User Show</h3>

<p>Let&#39;s finishe this tutorial by using a named route which implements the Users&#39; <code>show</code> API call.</p>

<blockquote>
<p>For readability concerns, code related to the <code>index</code> and <code>create</code> actions described in the previous sections is partially omitted.</p>
</blockquote>

<p>Add the test for the <code>show</code> method:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">require</span> <span class="s1">&#39;</span><span class="s">spec.spec_helper&#39;</span>

<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">clean_db</span><span class="p">()</span>
    <span class="n">MySql</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">TRUNCATE TABLE users;&quot;</span><span class="p">)</span>
<span class="k">end</span>


<span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">UsersController&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">#show&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
        <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
            <span class="n">roberto</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">create</span><span class="p">({</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">roberto&#39;</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">gin&#39;</span><span class="p">})</span>
        <span class="k">end</span><span class="p">)</span>

        <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
            <span class="n">roberto</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="k">end</span><span class="p">)</span>

        <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">shows a user&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GET&#39;</span><span class="p">,</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users/roberto&quot;</span>
            <span class="p">})</span>

            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
            <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">(</span><span class="n">roberto</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>We consider <code>first_name</code> as being the friendly identifier for a user. This is why we have a uniqueness constraint at database level on the column <code>first_name</code>, as defined in our migration here above.</p>
</blockquote>

<p>Test fails with a <code>404</code>:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●●●
<span class="m">2</span> successes / <span class="m">1</span> failure / <span class="m">0</span> pending : 0.191136 seconds.

Failure → ./spec/controllers/1/users_controllers_spec.lua @ 82
UsersController / <span class="c">#show / shows a user</span>
./spec/controllers/1/users_controllers_spec.lua:88: Expected objects to be the same. Passed in:
<span class="o">(</span>number<span class="o">)</span> 404
Expected:
<span class="o">(</span>number<span class="o">)</span> 200
</code></pre></div>
<p>Add the named route <code>:first_name</code> in <code>./config/routes.lua</code>:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">routes</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">gin.core.routes&#39;</span>

<span class="c1">-- define version</span>
<span class="kd">local</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">routes</span><span class="p">.</span><span class="n">version</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">-- define routes</span>
<span class="n">v1</span><span class="p">:</span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">controller</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">users&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">index&quot;</span> <span class="p">})</span>
<span class="n">v1</span><span class="p">:</span><span class="n">POST</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/users&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">controller</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">users&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">create&quot;</span> <span class="p">})</span>
<span class="n">v1</span><span class="p">:</span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/users/:first_name&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">controller</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">users&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">show&quot;</span> <span class="p">})</span>

<span class="k">return</span> <span class="n">routes</span>
</code></pre></div>
<p>Implement the <code>show</code> code the controller:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">UsersController</span> <span class="o">=</span> <span class="p">{}</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="k">function</span> <span class="nf">UsersController</span><span class="p">:</span><span class="n">show</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>
    <span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">find_by</span><span class="p">({</span> <span class="n">first_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">first_name</span> <span class="p">})</span>

    <span class="k">return</span> <span class="mi">200</span><span class="p">,</span> <span class="n">user</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">UsersController</span>
</code></pre></div>
<p>Test now succeed:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>busted spec/controllers/1/users_controllers_spec.lua

●●●
<span class="m">3</span> successes / <span class="m">0</span> failures / <span class="m">0</span> pending : 0.199211 seconds.
</code></pre></div>
<p>One last thing: we need to return a 404 if the user cannot be found. The test for the <code>show</code> action becomes:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">require</span> <span class="s1">&#39;</span><span class="s">spec.spec_helper&#39;</span>

<span class="kd">local</span> <span class="n">MySql</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">db.mysql&#39;</span>
<span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">clean_db</span><span class="p">()</span>
    <span class="n">MySql</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">TRUNCATE TABLE users;&quot;</span><span class="p">)</span>
<span class="k">end</span>


<span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">UsersController&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">clean_db</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">#show&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
        <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">when the user can be found&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="n">before_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
                <span class="n">roberto</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">create</span><span class="p">({</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">roberto&#39;</span><span class="p">,</span> <span class="n">last_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">gin&#39;</span><span class="p">})</span>
            <span class="k">end</span><span class="p">)</span>

            <span class="n">after_each</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
                <span class="n">roberto</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="k">end</span><span class="p">)</span>

            <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">shows a user&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
                <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GET&#39;</span><span class="p">,</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users/roberto&quot;</span>
                <span class="p">})</span>

                <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
                <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">(</span><span class="n">roberto</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">end</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>

        <span class="n">describe</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">when the user cannot be found&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
            <span class="n">it</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">returns a 404&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
                <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">hit</span><span class="p">({</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GET&#39;</span><span class="p">,</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/users/roberto&quot;</span>
                <span class="p">})</span>

                <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
                <span class="n">assert</span><span class="p">.</span><span class="n">are</span><span class="p">.</span><span class="n">same</span><span class="p">({},</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">end</span><span class="p">)</span>
        <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>And the controller implementation:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">UsersController</span> <span class="o">=</span> <span class="p">{}</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="k">function</span> <span class="nf">UsersController</span><span class="p">:</span><span class="n">show</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">Users</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">&#39;</span><span class="s">app.models.users&#39;</span>
    <span class="kd">local</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">.</span><span class="n">find_by</span><span class="p">({</span> <span class="n">first_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">first_name</span> <span class="p">})</span>

    <span class="k">if</span> <span class="n">user</span> <span class="k">then</span>
        <span class="k">return</span> <span class="mi">200</span><span class="p">,</span> <span class="n">user</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="mi">404</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">UsersController</span>
</code></pre></div>
<p>This concludes the tutorial. To see the complete code for this application, please checkout the Github repo <a href="https://github.com/ostinelli/gin-demo">gin-demo</a>.</p>

    </div>

    <div class="sidebar">
    </div>
  </div>
</div>

    </div>

    <div id="footer-top">
      <div class="container">
      </div>
    </div>

    <div id="footer-bottom">
      <div class="container">
        All rights reserved &copy; 2013
      </div>
    </div>
  </body>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45805640-1', 'gin.io');
  ga('send', 'pageview');

</script>

</html>

